<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Confirmados - Churrasco DIRSIS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="lista-header">
            <h1>üìã Lista de Confirmados</h1>
            <h2>Churrasco DIRSIS - 17/10 √†s 18h</h2>
            <p class="total-count">Total de pessoas: <strong>{{ total }}</strong></p>
        </div>

        {% if inscricoes %}
        <div class="lista-actions">
            <label class="select-all-container">
                <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                <span>Selecionar Todos</span>
            </label>
            <button id="delete-btn" class="btn-delete" onclick="deleteSelected()" disabled>
                üóëÔ∏è Deletar Selecionados (<span id="selected-count">0</span>)
            </button>
        </div>
        {% endif %}

        <div class="lista-content">
            {% if inscricoes %}
                {% for inscricao in inscricoes %}
                <div class="inscricao-card">
                    <div class="inscricao-header">
                        <label class="checkbox-container">
                            <input type="checkbox" class="inscricao-checkbox" value="{{ inscricao.email }}" onchange="updateDeleteButton()">
                        </label>
                        <div class="inscricao-info">
                            <div class="inscricao-nome">
                                üë§ <strong>{{ inscricao.nome or 'N/A' }} {{ inscricao.sobrenome or '' }}</strong>
                                {% if inscricao.rg %}
                                <span class="rg-badge">RG: {{ inscricao.rg }}</span>
                                {% endif %}
                            </div>
                            <span class="email">‚úâÔ∏è {{ inscricao.email }}</span>
                        </div>
                        <button class="btn-edit" onclick="editarInscricao('{{ inscricao.email }}', '{{ inscricao.nome or '' }}', '{{ inscricao.sobrenome or '' }}', '{{ inscricao.rg or '' }}')">‚úèÔ∏è</button>
                    </div>
                    {% if inscricao.familiares %}
                    <div class="familiares-list">
                        <strong>Acompanhantes:</strong>
                        <div class="familiares-grid">
                            {% for familiar in inscricao.familiares %}
                            <div class="familiar-row">
                                <label class="checkbox-container">
                                    <input type="checkbox" class="inscricao-checkbox" value="{{ familiar.id }}" onchange="updateDeleteButton()">
                                </label>
                                <div class="familiar-info">
                                    <span class="familiar-nome">{{ familiar.nome }}</span>
                                    <span class="familiar-sobrenome">{{ familiar.sobrenome or '' }}</span>
                                    {% if familiar.documento %}
                                    <span class="rg-badge">{{ familiar.documento }}</span>
                                    {% endif %}
                                </div>
                                <button class="btn-edit-small" onclick="editarConvidado('{{ familiar.id }}', '{{ familiar.nome }}', '{{ familiar.sobrenome or '' }}', '{{ familiar.documento or '' }}', '{{ inscricao.email }}')">‚úèÔ∏è</button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p class="no-data">Nenhuma confirma√ß√£o ainda. Seja o primeiro!</p>
            {% endif %}
        </div>

        <div class="back-link">
            <a href="/">‚¨ÖÔ∏è Voltar para Inscri√ß√£o</a>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal()">&times;</span>
            <h2 id="modal-title">‚úèÔ∏è Editar Cadastro</h2>
            <form id="editForm">
                <input type="hidden" id="edit-email">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-type">
                <div class="form-group">
                    <label>Nome:</label>
                    <input type="text" id="edit-nome" required>
                </div>
                <div class="form-group">
                    <label>Sobrenome:</label>
                    <input type="text" id="edit-sobrenome">
                </div>
                <div class="form-group">
                    <label>RG/CPF (opcional):</label>
                    <input type="text" id="edit-rg">
                </div>
                <button type="submit" class="btn-save">üíæ Salvar</button>
            </form>
        </div>
    </div>

    <script>
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.inscricao-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.inscricao-checkbox:checked');
            const deleteBtn = document.getElementById('delete-btn');
            const countSpan = document.getElementById('selected-count');
            
            countSpan.textContent = checkboxes.length;
            deleteBtn.disabled = checkboxes.length === 0;

            const selectAll = document.getElementById('select-all');
            const totalCheckboxes = document.querySelectorAll('.inscricao-checkbox').length;
            selectAll.checked = checkboxes.length === totalCheckboxes && totalCheckboxes > 0;
        }

        async function deleteSelected() {
            const checkboxes = document.querySelectorAll('.inscricao-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            
            if (ids.length === 0) return;
            
            if (!confirm(`Deseja realmente deletar ${ids.length} item(ns) selecionado(s)?`)) {
                return;
            }

            try {
                const response = await fetch('/api/inscricao/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.deleted.length} item(ns) deletado(s) com sucesso!`);
                    location.reload();
                } else {
                    alert('‚ùå ' + (result.error || 'Erro ao deletar'));
                }
            } catch (error) {
                alert('‚ùå Erro ao deletar. Tente novamente.');
            }
        }

        function editarInscricao(email, nome, sobrenome, rg) {
            document.getElementById('modal-title').textContent = '‚úèÔ∏è Editar Respons√°vel';
            document.getElementById('edit-type').value = 'responsavel';
            document.getElementById('edit-email').value = email;
            document.getElementById('edit-id').value = '';
            document.getElementById('edit-nome').value = nome;
            document.getElementById('edit-sobrenome').value = sobrenome;
            document.getElementById('edit-rg').value = rg;
            document.getElementById('editModal').style.display = 'block';
        }

        function editarConvidado(id, nome, sobrenome, documento, email) {
            document.getElementById('modal-title').textContent = '‚úèÔ∏è Editar Convidado';
            document.getElementById('edit-type').value = 'convidado';
            document.getElementById('edit-email').value = email;
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-nome').value = nome;
            document.getElementById('edit-sobrenome').value = sobrenome;
            document.getElementById('edit-rg').value = documento;
            document.getElementById('editModal').style.display = 'block';
        }

        function fecharModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const tipo = document.getElementById('edit-type').value;
            const dados = {
                email: document.getElementById('edit-email').value,
                nome: document.getElementById('edit-nome').value,
                sobrenome: document.getElementById('edit-sobrenome').value,
                rg: document.getElementById('edit-rg').value
            };

            if (tipo === 'convidado') {
                dados.id = document.getElementById('edit-id').value;
            }

            try {
                const endpoint = tipo === 'convidado' ? '/api/convidado/update' : '/api/inscricao/update';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('‚úÖ Cadastro atualizado com sucesso!');
                    location.reload();
                } else {
                    alert('‚ùå ' + (result.error || 'Erro ao atualizar'));
                }
            } catch (error) {
                alert('‚ùå Erro ao atualizar. Tente novamente.');
            }
        });

        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                fecharModal();
            }
        }
    </script>
</body>
</html>
